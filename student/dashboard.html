<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - School Library</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/responsive.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>üìö School Library</h2>
            </div>
            <div class="nav-menu" id="nav-menu">
                <a href="dashboard.html" class="nav-link active">
                    <span class="nav-icon">üìä</span> Dashboard
                </a>
                <a href="books.html" class="nav-link">
                    <span class="nav-icon">üìñ</span> Available Books
                </a>
                <div class="auth-links">
                    <button class="btn btn-secondary" id="logout-btn">
                        <span class="btn-icon">üö™</span> Logout
                    </button>
                </div>
            </div>
            <div class="hamburger" id="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <div class="container">
            <!-- Welcome Section -->
            <section class="welcome-section">
                <h1>Student Dashboard</h1>
                <p>Welcome back, <span id="student-name">Student</span>!</p>
            </section>
            
            <!-- Quick Overview -->
            <section class="overview-section">
                <h2 class="section-title">Quick Overview</h2>
                <div class="stats">
                    <div class="stat-card">
                        <h3>Books Borrowed</h3>
                        <p id="borrowed-count">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Available Books</h3>
                        <p id="available-count">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Overdue Books</h3>
                        <p id="overdue-count">0</p>
                    </div>
                </div>
            </section>

            <!-- My Books Section -->
            <section class="mybooks-section">
                <div class="section-header">
                    <h2 class="section-title">My Books</h2>
                    <div class="section-actions">
                        <button class="btn btn-primary" id="refresh-books">
                            <span class="btn-icon">üîÑ</span> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="books-container">
                    <div id="current-books" class="books-list">
                        <div class="loading-message">Loading your books...</div>
                    </div>
                    
                    <div id="no-books" class="no-books-message" style="display: none;">
                        <div class="no-books-icon">üìö</div>
                        <h3>No Books Borrowed</h3>
                        <p>You haven't borrowed any books yet. Start exploring our collection!</p>
                        <a href="books.html" class="btn btn-primary">Browse Available Books</a>
                    </div>
                </div>
            </section>

            <!-- Recent Activity -->
            <section class="activity-section">
                <h2 class="section-title">Recent Activity</h2>
                <div id="recent-activity" class="activity-list">
                    <div class="activity-item loading">
                        <div class="activity-content">
                            <div class="activity-text">Loading recent activity...</div>
                            <div class="activity-time">Just now</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
      <!-- Return Receipt Modal -->
    <div id="returnReceiptModal" class="modal" style="display: none;">
        <div class="modal-content receipt">
            <div class="modal-header">
                <h2>‚úÖ Book Return Receipt</h2>
                <button class="modal-close">&times;</button>
            </div>
            <div class="receipt-content">
                <div class="receipt-line"></div>
                <div id="returnReceiptDetails">
                    <!-- Receipt details will be inserted here -->
                </div>
                <div class="receipt-line"></div>
                <p class="receipt-note">Book returned successfully. Thank you for using the library!</p>
                <div class="receipt-actions">
                    <button id="printReturnReceipt" class="btn btn-primary">
                        <span class="btn-icon">üñ®Ô∏è</span> Print Receipt
                    </button>
                    <button id="closeReturnReceipt" class="btn btn-secondary">
                        <span class="btn-icon">‚úì</span> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2023 Philippine School Library Management System. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script>
// Supabase Configuration
const SUPABASE_URL = 'https://oyuuvsqqkdzbrkntmkyt.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95dXV2c3Fxa2R6YnJrbnRta3l0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MDEzNDQsImV4cCI6MjA3NzA3NzM0NH0.lz7lhuARXcMljy4so7pNJ6hkLca6MFhaCHqZreBeWls';

// Initialize Supabase client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Initialize the dashboard
document.addEventListener('DOMContentLoaded', async () => {
    // Check authentication
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
        window.location.href = '../index.html';
        return;
    }

    // Load dashboard data
    await loadStudentName();
    await loadDashboardStats();
    await loadMyBooks();
    await loadRecentActivity();

    // Refresh button
    document.getElementById('refresh-books').addEventListener('click', async () => {
        await loadMyBooks();
        await loadDashboardStats();
        await loadRecentActivity();
    });

    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = '../index.html';
    });

    // Hamburger menu
    const hamburger = document.getElementById('hamburger');
    const navMenu = document.getElementById('nav-menu');
    if (hamburger && navMenu) {
        hamburger.addEventListener('click', () => {
            hamburger.classList.toggle('active');
            navMenu.classList.toggle('active');
        });
    }
});

// Load student name
async function loadStudentName() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    const { data: userProfile } = await supabase
        .from('users')
        .select('full_name')
        .eq('id', session.user.id)
        .single();

    if (userProfile && userProfile.full_name) {
        document.getElementById('student-name').textContent = userProfile.full_name;
    }
}

// Load dashboard statistics
async function loadDashboardStats() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    try {
        // Available books
        const { count: availableBooks } = await supabase
            .from('books')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'Available');
        
        // My borrowed books - using the same approach as Recent Activity
        const { data: myBorrowed, error: borrowedError } = await supabase
            .from('borrowed_books')
            .select('*')
            .eq('user_id', session.user.id);
        
        const borrowedCount = myBorrowed ? myBorrowed.length : 0;
        
        // Overdue books - check if return_date is in the past
        const today = new Date().toISOString().split('T')[0];
        let overdueCount = 0;
        if (myBorrowed) {
            overdueCount = myBorrowed.filter(book => {
                return book.return_date && book.return_date < today;
            }).length;
        }
        
        // Update UI
        document.getElementById('available-count').textContent = availableBooks || 0;
        document.getElementById('borrowed-count').textContent = borrowedCount;
        document.getElementById('overdue-count').textContent = overdueCount;
        
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

// Load my books - USING THE SAME APPROACH AS RECENT ACTIVITY
// Load my books - UPDATED FOR YOUR TABLE STRUCTURE
async function loadMyBooks() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    try {
        // Use the same query structure as Recent Activity
        const { data: borrowedRecords, error } = await supabase
            .from('borrowed_books')
            .select('*')
            .eq('user_id', session.user.id)
            .order('borrow_date', { ascending: false });

        console.log('Borrowed records:', borrowedRecords);

        const booksContainer = document.getElementById('current-books');
        const noBooksMessage = document.getElementById('no-books');
        
        if (error) {
            console.error('Error loading borrowed records:', error);
            throw error;
        }

        if (!borrowedRecords || borrowedRecords.length === 0) {
            console.log('No borrowed books found');
            booksContainer.style.display = 'none';
            noBooksMessage.style.display = 'block';
            return;
        }

        // Get book details for each borrowed book
        const booksWithDetails = [];
        for (const record of borrowedRecords) {
            const { data: book, error: bookError } = await supabase
                .from('books')
                .select('*')
                .eq('id', record.book_id)
                .single();
            
            if (!bookError && book) {
                booksWithDetails.push({
                    record: record,
                    book: book
                });
            } else {
                console.log('Error fetching book details for book_id:', record.book_id, bookError);
            }
        }

        console.log('Books with details:', booksWithDetails);

        booksContainer.style.display = 'block';
        noBooksMessage.style.display = 'none';

        booksContainer.innerHTML = booksWithDetails.map(item => {
            // Format dates safely
            const borrowDate = formatDate(item.record.borrow_date);
            const pickupDate = formatDate(item.record.pickup_date);
            
            // Calculate due date (14 days from pickup date)
            let dueDate, isOverdue, daysRemaining;
            
            if (item.record.pickup_date && isValidDate(item.record.pickup_date)) {
                // Calculate due date as 14 days from pickup date
                const pickupDateObj = new Date(item.record.pickup_date);
                const dueDateObj = new Date(pickupDateObj);
                dueDateObj.setDate(pickupDateObj.getDate() + 14); // 14 days from pickup
                
                dueDate = formatDate(dueDateObj);
                const today = new Date();
                isOverdue = dueDateObj < today;
                daysRemaining = Math.ceil((dueDateObj - today) / (1000 * 60 * 60 * 24));
            } else {
                // Fallback if pickup_date is invalid
                dueDate = 'Not set';
                isOverdue = false;
                daysRemaining = 0;
            }
            
            // Use book properties
            const bookTitle = item.book.title || 'Unknown Book';
            const bookAuthor = item.book.author || 'Unknown Author';
            const imageUrl = item.book.image_url || `https://source.unsplash.com/random/150x200/?book`;
            
            return `
    <div class="book-item ${isOverdue ? 'overdue' : ''}">
        <div class="book-cover">
            <img src="${imageUrl}" alt="${bookTitle}" onerror="this.src='https://source.unsplash.com/random/150x200/?book'">
        </div>
        <div class="book-details">
            <h3 class="book-title">${bookTitle}</h3>
            <p class="book-author">by ${bookAuthor}</p>
            <div class="book-dates">
                <div class="date-item">
                    <span class="date-label">Borrowed Date:</span>
                    <span class="date-value">${borrowDate}</span>
                </div>
                <div class="date-item">
                    <span class="date-label">Pickup Date:</span>
                    <span class="date-value">${pickupDate}</span>
                </div>
                <div class="date-item">
                    <span class="date-label ${isOverdue ? 'overdue-text' : ''}">Due Date:</span>
                    <span class="date-value ${isOverdue ? 'overdue-text' : ''}">${dueDate}</span>
                </div>
                ${!isOverdue && daysRemaining >= 0 ? `
                    <div class="date-item">
                        <span class="date-label">Days Left:</span>
                        <span class="date-value remaining-days">${daysRemaining} days</span>
                    </div>
                ` : isOverdue ? `
                    <div class="date-item">
                        <span class="date-label overdue-text">Days Overdue:</span>
                        <span class="date-value overdue-text">${Math.abs(daysRemaining)} days</span>
                    </div>
                ` : ''}
            </div>
        </div>
        <div class="book-actions">
            <button class="btn btn-success return-btn" 
                    data-id="${item.record.id}" 
                    data-book-id="${item.record.book_id}"
                    data-book-title="${bookTitle}"
                    data-book-author="${bookAuthor}">
                <span class="btn-icon">‚Ü©</span> Return Book
            </button>
        </div>
    </div>
`;

// Then update the event listener to pass the extra data
document.querySelectorAll('.return-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const recordId = e.target.getAttribute('data-id');
        const bookId = e.target.getAttribute('data-book-id');
        const bookTitle = e.target.getAttribute('data-book-title');
        const bookAuthor = e.target.getAttribute('data-book-author');
        returnBook(recordId, bookId, bookTitle, bookAuthor);
    });
});
        });

    } catch (error) {
        console.error('Error loading my books:', error);
        const booksContainer = document.getElementById('current-books');
        booksContainer.innerHTML = `
            <div class="error-message">
                <p>Error loading books. Please try again.</p>
                <p style="font-size: 0.8rem; margin-top: 0.5rem;">Error: ${error.message}</p>
            </div>
        `;
    }
}

// Helper function to format dates safely
function formatDate(dateString) {
    if (!dateString) return 'Not set';
    
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            return 'Invalid date';
        }
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    } catch (error) {
        return 'Invalid date';
    }
}

// Helper function to check if a date is valid
function isValidDate(dateString) {
    if (!dateString) return false;
    
    try {
        const date = new Date(dateString);
        return !isNaN(date.getTime());
    } catch (error) {
        return false;
    }
}

// Load recent activity
async function loadRecentActivity() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    try {
        const { data: recentActivity, error } = await supabase
            .from('borrowed_books')
            .select(`
                *,
                books (title)
            `)
            .eq('user_id', session.user.id)
            .order('created_at', { ascending: false })
            .limit(5);

        const activityContainer = document.getElementById('recent-activity');
        
        if (error) throw error;

        if (!recentActivity || recentActivity.length === 0) {
            activityContainer.innerHTML = `
                <div class="activity-item">
                    <div class="activity-content">
                        <div class="activity-text">No recent activity</div>
                        <div class="activity-time">Start borrowing books to see activity here</div>
                    </div>
                </div>
            `;
            return;
        }

        activityContainer.innerHTML = recentActivity.map(activity => {
            const date = new Date(activity.created_at);
            const timeAgo = getTimeAgo(date);
            const bookTitle = activity.books?.title || 'Unknown Book';
            
            // Since there's no status column, we'll assume all are borrow activities
            return `
                <div class="activity-item">
                    <div class="activity-content">
                        <div class="activity-text">Borrowed "${bookTitle}"</div>
                        <div class="activity-time">${timeAgo}</div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading recent activity:', error);
        const activityContainer = document.getElementById('recent-activity');
        activityContainer.innerHTML = `
            <div class="activity-item">
                <div class="activity-content">
                    <div class="activity-text">Error loading activity</div>
                    <div class="activity-time">Please try again later</div>
                </div>
            </div>
        `;
    }
}

// Return a book
async function returnBook(recordId, bookId, bookTitle, bookAuthor) {
    if (!confirm('Are you sure you want to return this book?')) {
        return;
    }

    try {
        // Show loading state on the book item
        const returnBtn = document.querySelector(`.return-btn[data-id="${recordId}"]`);
        const bookItem = returnBtn.closest('.book-item');
        bookItem.classList.add('returning');
        
        returnBtn.innerHTML = '<span class="btn-icon">‚è≥</span> Returning...';
        returnBtn.disabled = true;

        // Get book details before deleting the record
        const { data: bookDetails } = await supabase
            .from('books')
            .select('*')
            .eq('id', bookId)
            .single();

        // Get borrowed record details
        const { data: borrowedRecord } = await supabase
            .from('borrowed_books')
            .select('*')
            .eq('id', recordId)
            .single();

        // Delete the borrowed record
        const { error } = await supabase
            .from('borrowed_books')
            .delete()
            .eq('id', recordId);

        if (error) throw error;

        // Update book status to Available
        const { error: bookError } = await supabase
            .from('books')
            .update({ status: 'Available' })
            .eq('id', bookId);

        if (bookError) throw error;

        // Show success receipt
        await showReturnReceipt({
            bookTitle: bookTitle || bookDetails?.title || 'Unknown Book',
            bookAuthor: bookAuthor || bookDetails?.author || 'Unknown Author',
            borrowDate: borrowedRecord?.borrow_date,
            returnDate: new Date().toISOString().split('T')[0],
            receiptNo: borrowedRecord?.receipt_no || 'N/A'
        });

        // Reload data after a short delay to show the receipt
        setTimeout(async () => {
            await loadMyBooks();
            await loadDashboardStats();
            await loadRecentActivity();
        }, 2000);

    } catch (error) {
        console.error('Error returning book:', error);
        alert('Error returning book. Please try again.');
        
        // Reset button state on error
        const returnBtn = document.querySelector(`.return-btn[data-id="${recordId}"]`);
        if (returnBtn) {
            returnBtn.innerHTML = '<span class="btn-icon">‚Ü©</span> Return Book';
            returnBtn.disabled = false;
        }
        const bookItem = document.querySelector(`.book-item .return-btn[data-id="${recordId}"]`)?.closest('.book-item');
        if (bookItem) {
            bookItem.classList.remove('returning');
        }
    }
}
// Show return receipt modal
async function showReturnReceipt(returnDetails) {
    const modal = document.getElementById('returnReceiptModal');
    const receiptDetails = document.getElementById('returnReceiptDetails');
    
    // Format dates
    const borrowDate = formatDate(returnDetails.borrowDate);
    const returnDate = formatDate(returnDetails.returnDate);
    const returnTime = new Date().toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
    
    receiptDetails.innerHTML = `
        <div class="receipt-details">
            <div class="receipt-item">
                <span class="receipt-label">Book Title:</span>
                <span class="receipt-value">${returnDetails.bookTitle}</span>
            </div>
            <div class="receipt-item">
                <span class="receipt-label">Author:</span>
                <span class="receipt-value">${returnDetails.bookAuthor}</span>
            </div>
            <div class="receipt-item">
                <span class="receipt-label">Borrow Date:</span>
                <span class="receipt-value">${borrowDate}</span>
            </div>
            <div class="receipt-item">
                <span class="receipt-label">Return Date:</span>
                <span class="receipt-value">${returnDate}</span>
            </div>
            <div class="receipt-item">
                <span class="receipt-label">Return Time:</span>
                <span class="receipt-value">${returnTime}</span>
            </div>
            <div class="receipt-item">
                <span class="receipt-label">Receipt No:</span>
                <span class="receipt-value">${returnDetails.receiptNo}</span>
            </div>
            <div class="receipt-item" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #ddd;">
                <span class="receipt-label">Status:</span>
                <span class="receipt-value" style="color: var(--success);">RETURNED ‚úì</span>
            </div>
        </div>
    `;
    
    // Show modal
    modal.style.display = 'flex';
    
    // Add event listeners for modal buttons
    document.getElementById('printReturnReceipt').onclick = () => printReturnReceipt();
    document.getElementById('closeReturnReceipt').onclick = () => closeReturnReceiptModal();
    
    // Close modal when clicking X or outside
    modal.querySelector('.modal-close').onclick = () => closeReturnReceiptModal();
    modal.onclick = (e) => {
        if (e.target === modal) closeReturnReceiptModal();
    };
}

// Close return receipt modal
function closeReturnReceiptModal() {
    const modal = document.getElementById('returnReceiptModal');
    modal.style.display = 'none';
}



// Helper function to get time ago
function getTimeAgo(date) {
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
    if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} days ago`;
    
    return date.toLocaleDateString();
}
    </script>
</body>
</html>